# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

image: khos2ow/ci-cd-tools:latest

# Define CI stages
stages:
  - test
  - archive
  - integration
  - deploy

# Global Variables
variables:
  GIT_DEPTH: "40"
  MAVEN_OPTS: '-Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=INFO 
               -Dorg.slf4j.simpleLogger.showDateTime=true 
               -Djava.awt.headless=true 
               -Dmaven.repo.local=/root/.m2/repository'

.load_swift_function: &LOAD_SWIFT |
  function load_swift() {
    export OS_USERNAME=cloudops-ccontini
    export OS_TENANT_NAME=cloudops-jenkins-swift
    export OS_PASSWORD=ubTQGjjPqEFOl9T4
    export OS_AUTH_URL=https://auth-qc.cloud.ca/v2.0
    export OS_REGION_NAME=east
  }

.yum_repo_path_function: &YUM_REPO_PATH |
  function yum_repo_path() {
    if [ "${CI_COMMIT_REF_NAME}" = "cca_custom_4.10jdk8" -a "${CI_PROJECT_NAMESPACE}" = "eng" ]; then
      local version=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:1.3.1:exec)
      local major_version=`echo ${version} | cut -d. -f1`.`echo ${version} | cut -d. -f2`
      local os_target="centos7"

      case "$version" in
        *"-SNAPSHOT") local stable_prefix="unstable" ;;
        *)            local stable_prefix="stable"   ;;
      esac

      echo "${stable_prefix}/${major_version}/${os_target}"
    else
      echo "develop/${CI_PROJECT_NAMESPACE}/${CI_COMMIT_REF_NAME}"
    fi
  }

# RAT checks
Audit:
  image:
    name: khos2ow/cloudstack-rpm-builder:centos7
    entrypoint: ["/bin/bash", "-l", "-c"]
  stage: test
  before_script:
    - environment-info.sh
  script:
    - mvn --activate-profiles developer,systemvm -Dsimulator --projects='org.apache.cloudstack:cloudstack' clean org.apache.rat:apache-rat-plugin:0.12:check
  artifacts:
    name: "audit_report_${CI_BUILD_REF_SLUG}"
    paths:
      - "target/rat.txt"
    when: on_failure
    expire_in: 1 day

# Compile and test and verify build
Verify:
  image:
    name: khos2ow/cloudstack-rpm-builder:centos7
    entrypoint: ["/bin/bash", "-l", "-c"]
  stage: test
  before_script:
    - environment-info.sh
  script:
    - mvn --activate-profiles developer,systemvm -Dsimulator clean verify
  artifacts:
    name: "test_report_${CI_BUILD_REF_SLUG}"
    paths:
      - "*/target/surefire-reports"
      - "*/*/target/surefire-reports"
      - "*/*/*/target/surefire-reports"
      - "*/*/*/*/target/surefire-reports"

      - "*/target/checkstyle-result.xml"
      - "*/*/target/checkstyle-result.xml"
      - "*/*/*/target/checkstyle-result.xml"
      - "*/*/*/*/target/checkstyle-result.xml"
    when: on_failure
    expire_in: 1 day

# Archive RPMs to object storage
RPM:
  image:
    name: khos2ow/cloudstack-rpm-builder:centos7
    entrypoint: ["/bin/bash", "-l", "-c"]
  stage: archive
  before_script:
    - environment-info.sh
    - pip install python-swiftclient
    - pip install python-keystoneclient
    - *LOAD_SWIFT
    - *YUM_REPO_PATH
  script:
    # download required vhd-util file, if it doesn't exist
    - wget http://download.cloud.com.s3.amazonaws.com/tools/vhd-util --directory-prefix=${CI_PROJECT_DIR}/scripts/vm/hypervisor/xenserver

    # do the packaging and creating RPMs
    - /usr/local/bin/docker-entrypoint.sh --workspace-path ${CI_PROJECT_DIR} --distribution centos7 --use-timestamp

    # upload RPMs to swift object storage
    - |
      load_swift

      swift_path=`yum_repo_path`
      namespace="cloudstack"

      # upload to swift
      swift post ${namespace} -r '.r:*,.rlistings'
      swift upload ${namespace} --object-name ${swift_path} ${CI_PROJECT_DIR}/dist/rpmbuild/RPMS

      mkdir -p ${CI_PROJECT_DIR}/target/rpms

      # fix repo metadata
      if [ -n "${swift_path}" ]; then
        swift download ${namespace} --prefix ${swift_path} --output-dir=${CI_PROJECT_DIR}/target/rpms
        createrepo --update ${CI_PROJECT_DIR}/target/rpms/${swift_path}
        swift delete ${namespace} --prefix ${swift_path}/repodata
        swift upload ${namespace} --object-name ${swift_path}/repodata/ ${CI_PROJECT_DIR}/target/rpms/${swift_path}/repodata/
      fi

# Archive SystemVM Template to object storage
SysVM Template:
  image:
    name: khos2ow/cloudstack-rpm-builder:centos7
    entrypoint: ["/bin/bash", "-l", "-c"]
  stage: archive
  when: manual
  before_script:
    - environment-info.sh
  script:
    - echo "TODO"
  except:
    - master

# Run integration tests against live build
integration test:
  stage: integration
  when: manual
  before_script:
    - environment-info.sh
  script:
    - echo "TODO"
  except:
    - master
    - cca_custom_4.10jdk8

.deploy: &DEPLOY
  stage: deploy
  when: manual
  before_script:
    - environment-info.sh
    - *YUM_REPO_PATH
  script:
    - |
      mkdir -p ~/.ssh

      echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
      chmod 700 ~/.ssh/id_rsa

      ssh-keyscan ${LAB_ENV_IP} >> ~/.ssh/known_hosts
      chmod 644 ~/.ssh/known_hosts

      export REPO_BASE="https://objects-east.cloud.ca/v1/a8286006ae394ede8bc081f586ae048d/cloudstack/"
      export REPO_PATH="`yum_repo_path`"

      ssh -T ${SSH_USER}@${LAB_ENV_IP} << EOF
        sudo su -

        set -e

        # stop services
        echo -e "stopping cloudstack-usage...\n"
        systemctl stop cloudstack-usage

        echo -e "stopping cloudstack-management...\n"
        systemctl stop cloudstack-management

        echo -e "stopping chef-client...\n"
        systemctl stop chef-client

        # update yum repo
        echo -e "updating /etc/yum.repos.d/cloudstack.repo...\n"

        sed -i "s|^baseUrl=${REPO_BASE}.*|baseUrl=${REPO_BASE}${REPO_PATH}|gI" /etc/yum.repos.d/cloudstack.repo
        sed -i "s/^enabled=0/enabled=1/gI" /etc/yum.repos.d/cloudstack.repo

        cat /etc/yum.repos.d/cloudstack.repo
        echo ""

        # upgrade cloudstack
        echo -e "updating cloudstack rpm...\n"
        yum clean metadata
        yum upgrade --assumeyes cloudstack-*

        # start services
        echo -e "starting cloudstack-management...\n"
        systemctl start cloudstack-management

        echo -e "starting cloudstack-usage...\n"
        systemctl start cloudstack-usage

        echo -e "starting chef-client...\n"
        systemctl start chef-client
      EOF
  environment:
    name: ${LAB_ENV_NAME}

coe-acs1-mgt01:
  <<: *DEPLOY
  variables:
    LAB_ENV_NAME: "coe-acs1-mgt01"
    LAB_ENV_IP: "172.16.21.119"

coe-acs2-mgt01:
  <<: *DEPLOY
  variables:
    LAB_ENV_NAME: "coe-acs2-mgt01"
    LAB_ENV_IP: "172.16.21.152"

coe-acs2-mgt02:
  <<: *DEPLOY
  variables:
    LAB_ENV_NAME: "coe-acs2-mgt02"
    LAB_ENV_IP: "172.16.21.138"

coe-dev1-acs01:
  <<: *DEPLOY
  variables:
    LAB_ENV_NAME: "coe-dev1-acs01"
    LAB_ENV_IP: "172.16.21.151"

coe-dev2-cs01:
  <<: *DEPLOY
  variables:
    LAB_ENV_NAME: "coe-dev2-cs01"
    LAB_ENV_IP: "172.16.21.104"

coe-dev3-acs01:
  <<: *DEPLOY
  variables:
    LAB_ENV_NAME: "coe-dev3-acs01"
    LAB_ENV_IP: "172.16.21.133"

coe-stg-acs01:
  <<: *DEPLOY
  variables:
    LAB_ENV_NAME: "coe-stg-acs01"
    LAB_ENV_IP: "172.16.21.113"

coe-stg-acs02:
  <<: *DEPLOY
  variables:
    LAB_ENV_NAME: "coe-stg-acs02"
    LAB_ENV_IP: "172.16.21.102"

cca-r1-beta02-mtg02:
  <<: *DEPLOY
  variables:
    LAB_ENV_NAME: "cca-r1-beta02-mtg02"
    LAB_ENV_IP: "172.27.2.119"
